<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pikmin 座標圖鑑</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, Fragment } = React;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // ★★★ 你的新專案 pikcardrecord ★★★
        const firebaseConfig = {
            apiKey: "AIzaSyDEsqE2MtAJnMGm17kwjnftuCcieV0z6Bc",
            authDomain: "pikcardrecord.firebaseapp.com",
            projectId: "pikcardrecord",
            storageBucket: "pikcardrecord.firebasestorage.app",
            messagingSenderId: "441551391616",
            appId: "1:441551391616:web:8f6fe2c7f46bb6de038f65"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = 'pikmin-public-v1';

        // ★★★ 只有用這個 Email 登入才有編輯權限 ★★★
        const ADMIN_EMAIL = "admin@pikmin.map"; 

        const Icon = ({ path }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                {path}
            </svg>
        );

        const ICONS = {
            Leaf: <path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12" />,
            Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M7 10l5 5 5-5 M12 15V3" />,
            Upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4 M17 8l-5-5-5 5 M12 3v12" />,
            Plus: <path d="M5 12h14 M12 5v14" />,
            Search: <Fragment><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></Fragment>,
            Edit2: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />,
            Trash2: <path d="M3 6h18 M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6 M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2 M10 11v6 M14 11v6" />,
            MapPin: <Fragment><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></Fragment>,
            Copy: <Fragment><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></Fragment>,
            Check: <polyline points="20 6 9 17 4 12" />,
            ExternalLink: <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6 M15 3h6v6 M10 14 21 3" />,
            AlertTriangle: <Fragment><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" x2="12" y1="9" y2="13" /><line x1="12" x2="12.01" y1="17" y2="17" /></Fragment>,
            X: <path d="M18 6 6 18 M6 6l12 12" />,
            Save: <Fragment><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></Fragment>,
            Lock: <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
        };

        const INITIAL_SEEDS = [];

        const App = () => {
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [postcards, setPostcards] = useState([]);
            const [loading, setLoading] = useState(true);
            const hasInitializedSeeds = useRef(false);
            const [mainTab, setMainTab] = useState('明信片');
            const [activeCategory, setActiveCategory] = useState("全部");
            const [searchTerm, setSearchTerm] = useState("");
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [deleteId, setDeleteId] = useState(null);
            const [copyFeedback, setCopyFeedback] = useState(null);
            const [isImporting, setIsImporting] = useState(false);
            const [isUploading, setIsUploading] = useState(false);
            const [selectedIds, setSelectedIds] = useState(new Set());

            const fileInputRef = useRef(null);
            const csvInputRef = useRef(null);
            const [formData, setFormData] = useState({ mainType: "明信片", category: "", series: "", name: "", lat: "", lng: "", location: "", type: "蘑菇", imageUrl: "" });

            useEffect(() => {
                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        setIsAdmin(u.email === ADMIN_EMAIL);
                    } else {
                        setUser(null);
                        setIsAdmin(false);
                        setSelectedIds(new Set());
                    }
                });
            }, []);

            useEffect(() => {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'pikmin_postcards'));
                const unsubscribe = onSnapshot(q, async (snapshot) => {
                    const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    docs.sort((a, b) => new Date(b.lastUpdated || 0) - new Date(a.lastUpdated || 0));
                    setPostcards(docs);
                    setLoading(false);
                }, (error) => { 
                    console.error("Data sync error:", error); 
                    setLoading(false); 
                });
                return () => unsubscribe();
            }, [isAdmin]);

            const toggleSelection = (id) => {
                const newSelected = new Set(selectedIds);
                if (newSelected.has(id)) {
                    newSelected.delete(id);
                } else {
                    newSelected.add(id);
                }
                setSelectedIds(newSelected);
            };

            const handleAdminLogin = async () => {
                if (isAdmin) {
                    if(confirm("確定要登出管理員嗎？")) await signOut(auth);
                } else {
                    const email = prompt("請輸入管理員 Email:");
                    if (!email) return;
                    const password = prompt("請輸入密碼:");
                    if (!password) return;
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        alert("登入成功！編輯模式已開啟。");
                    } catch (error) {
                        alert("登入失敗: " + error.message);
                    }
                }
            };

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => { setFormData(prev => ({ ...prev, imageUrl: event.target.result })); };
                reader.readAsDataURL(file);
                setSelectedFileState(file);
            };
            const handleRemoveImage = () => { setFormData(prev => ({ ...prev, imageUrl: "" })); setSelectedFileState(null); };

            const handleOpenModal = (item = null) => {
                if (item) {
                    setEditingItem(item);
                    setFormData({ imageUrl: "", mainType: "明信片", ...item });
                    setSelectedFileState(null);
                } else {
                    setEditingItem(null);
                    setFormData({ mainType: mainTab, category: activeCategory === "全部" ? "" : activeCategory, series: "", name: "", lat: "", lng: "", location: "", type: mainTab === '明信片' ? "蘑菇" : "", imageUrl: "" });
                    setSelectedFileState(null);
                }
                setIsModalOpen(true);
            };

            const deleteOldImage = async (url) => {
                if (!url) return;
                try {
                    const imageRef = ref(storage, url);
                    await deleteObject(imageRef);
                } catch (error) { console.log("Delete image ignored:", error); }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!isAdmin) return;
                setIsUploading(true);
                const timestamp = new Date().toISOString();
                let finalImageUrl = formData.imageUrl;
                try {
                    if (selectedFileState) {
                        if (editingItem && editingItem.imageUrl) await deleteOldImage(editingItem.imageUrl);
                        const fileExt = selectedFileState.name.split('.').pop();
                        const fileName = `${Date.now()}.${fileExt}`;
                        const storageRef = ref(storage, `images/${fileName}`);
                        await uploadBytes(storageRef, selectedFileState);
                        finalImageUrl = await getDownloadURL(storageRef);
                    } else if (editingItem && editingItem.imageUrl && !formData.imageUrl) {
                        await deleteOldImage(editingItem.imageUrl);
                    }

                    const newItem = { ...formData, imageUrl: finalImageUrl, lastUpdated: timestamp };
                    if (editingItem) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pikmin_postcards', editingItem.id), newItem, { merge: true });
                    } else {
                        const newId = Date.now().toString();
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pikmin_postcards', newId), { ...newItem, id: newId });
                    }
                    setIsModalOpen(false);
                } catch (error) { console.error("Save error:", error); alert("儲存失敗: " + error.message); } finally { setIsUploading(false); }
            };

            const handleBatchDelete = async () => {
                if (selectedIds.size === 0) return;
                if (!confirm(`確定要永久刪除選取的 ${selectedIds.size} 筆資料嗎？`)) return;

                setIsUploading(true);
                try {
                    const promises = Array.from(selectedIds).map(async (id) => {
                        const itemToDelete = postcards.find(p => p.id === id);
                        if (itemToDelete) {
                            if (itemToDelete.imageUrl) await deleteOldImage(itemToDelete.imageUrl);
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pikmin_postcards', id));
                        }
                    });
                    
                    await Promise.all(promises);
                    setSelectedIds(new Set());
                    alert("批量刪除完成！");
                } catch (error) {
                    console.error("Batch delete error:", error);
                    alert("刪除失敗: " + error.message);
                } finally {
                    setIsUploading(false);
                }
            };

            const confirmDelete = async () => {
                if (deleteId && isAdmin) {
                    try { 
                        const itemToDelete = postcards.find(p => p.id === deleteId);
                        if (itemToDelete && itemToDelete.imageUrl) await deleteOldImage(itemToDelete.imageUrl);
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pikmin_postcards', deleteId)); 
                        setDeleteId(null); 
                    } catch (error) { console.error("Delete error:", error); }
                }
            };

            const handleGroupDelete = (groupKey, itemsInGroup) => {
                if (!isAdmin) return;
                const confirmMsg = `警告：您確定要刪除「${groupKey}」類別下的所有 ${itemsInGroup.length} 筆資料嗎？\n此動作無法復原！`;
                if (confirm(confirmMsg)) {
                    const idsToDelete = itemsInGroup.map(item => item.id);
                    setIsUploading(true);
                    const deletePromises = idsToDelete.map(async (id) => {
                        const itemToDelete = postcards.find(p => p.id === id);
                        if (itemToDelete && itemToDelete.imageUrl) await deleteOldImage(itemToDelete.imageUrl);
                        return deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pikmin_postcards', id));
                    });
                    Promise.all(deletePromises).then(() => {
                        alert("刪除成功！");
                        setSelectedIds(new Set());
                        setIsUploading(false);
                    }).catch((error) => {
                        console.error("Delete error:", error);
                        alert("刪除失敗: " + error.message);
                        setIsUploading(false);
                    });
                }
            };

            const handleCopyText = (text, feedbackKey) => {
                navigator.clipboard.writeText(text).then(() => { setCopyFeedback(feedbackKey); setTimeout(() => setCopyFeedback(null), 2000); });
            };

            const handleExportCSV = () => {
                const headers = ["ID", "大區分類", "大類別", "子類別", "名稱", "類型", "地點", "緯度", "經度", "最後更新時間", "圖片連結"];
                const csvContent = [headers.join(","), ...postcards.map(item => [item.id, `"${item.mainType || '明信片'}"`, `"${item.category || ''}"`, `"${item.series || ''}"`, `"${item.name || ''}"`, `"${item.type || ''}"`, `"${item.location || ''}"`, item.lat, item.lng, item.lastUpdated, `"${item.imageUrl || ''}"`].join(","))].join("\n");
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.setAttribute("download", `pikmin_postcards_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportCSV = (e) => {
                const file = e.target.files[0];
                if (!file || !isAdmin) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const rows = text.split('\n');
                    const dataRows = rows.slice(1).filter(row => row.trim() !== '');
                    setIsImporting(true);
                    try {
                        // ★★★ 工業級 CSV 解析器，完美處理引號與逗號 ★★★
                        const parseCSVRow = (str) => {
                            let ret = [], val = '', inQ = false;
                            for (let i = 0; i < str.length; i++) {
                                let c = str[i];
                                if (inQ) {
                                    if (c === '"') {
                                        if (i + 1 < str.length && str[i+1] === '"') { val += '"'; i++; } 
                                        else { inQ = false; }
                                    } else { val += c; }
                                } else {
                                    if (c === '"') { inQ = true; }
                                    else if (c === ',') { ret.push(val.trim()); val = ''; }
                                    else { val += c; }
                                }
                            }
                            ret.push(val.trim());
                            return ret;
                        };

                        const promises = dataRows.map(row => {
                            const cols = parseCSVRow(row);
                            
                            // 預防空行
                            if (cols.length < 2) return null;

                            const id = cols[0] || Date.now().toString() + Math.random().toString().slice(2,5);
                            let importedName = cols[4];
                            
                            // 智慧補名邏輯
                            if (!importedName && cols[6]) {
                                importedName = cols[6];
                            }

                            const item = {
                                id: id,
                                mainType: cols[1] || '明信片',
                                category: cols[2] || '',
                                series: cols[3] || '',
                                name: importedName,
                                type: cols[5] || '',
                                location: cols[6] || '',
                                lat: cols[7] || '',
                                lng: cols[8] || '',
                                lastUpdated: cols[9] || new Date().toISOString(),
                                imageUrl: cols[10] || ''
                            };
                            return setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pikmin_postcards', id), item, { merge: true });
                        }).filter(p => p !== null);

                        await Promise.all(promises);
                        alert(`匯入完成！成功匯入 ${promises.length} 筆資料。`);
                    } catch (error) { 
                        console.error(error);
                        alert("匯入失敗，請確認格式。錯誤訊息: " + error.message); 
                    } finally { 
                        setIsImporting(false); 
                        e.target.value = ''; 
                    }
                };
                reader.readAsText(file);
            };

            const availableCategories = [...new Set(postcards.filter(p => (p.mainType || '明信片') === '明信片').map(p => p.category))].sort();
            const categories = ["全部", ...availableCategories];
            const availableSubCategories = [...new Set(postcards.filter(p => (p.mainType || '明信片') === '明信片' && (!formData.category || p.category === formData.category)).map(p => p.series).filter(Boolean))].sort();
            
            const availablePureTypes = [...new Set(postcards.filter(p => p.mainType === '純點').map(p => p.type).filter(Boolean))].sort();
            const availableEventTypes = [...new Set(postcards.filter(p => p.mainType === '活動金盆').map(p => p.type).filter(Boolean))].sort();

            const displayedItems = postcards.filter(item => {
                const itemMainType = item.mainType || '明信片';
                if (itemMainType !== mainTab) return false;
                
                const s = searchTerm.toLowerCase();
                const matchesSearch = 
                    (item.name || "").toLowerCase().includes(s) || 
                    (item.location || "").toLowerCase().includes(s) || 
                    (item.type || "").toLowerCase().includes(s) ||
                    (item.series || "").toLowerCase().includes(s);

                if (mainTab === '明信片') {
                    return (activeCategory === "全部" || item.category === activeCategory) && matchesSearch;
                } else {
                    return matchesSearch;
                }
            });

            const groupedPostcards = displayedItems.reduce((groups, item) => {
                const key = mainTab === '明信片' ? (item.series || "未分類") : (item.type || "未分類");
                if (!groups[key]) groups[key] = [];
                groups[key].push(item);
                return groups;
            }, {});

            const [selectedFileState, setSelectedFileState] = useState(null);

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-20">
                    <header className="bg-emerald-600 text-white shadow-lg sticky top-0 z-20">
                        <div className="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-2"><Icon path={ICONS.Leaf} /><h1 className="text-xl font-bold">Pikmin 座標圖鑑</h1></div>
                            <div className="flex gap-2 items-center">
                                {/* 登入按鈕 */}
                                <button onClick={handleAdminLogin} className={`p-2 rounded-full hover:bg-emerald-700 transition-colors ${isAdmin ? 'text-yellow-300' : 'text-emerald-200'}`} title={isAdmin ? "登出管理員" : "管理員登入"}>
                                    <Icon path={ICONS.Lock} />
                                </button>
                                
                                <button onClick={handleExportCSV} className="bg-emerald-700/50 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg text-sm flex items-center gap-2"><Icon path={ICONS.Download} />匯出</button>
                                
                                {isAdmin && (
                                    <>
                                        {/* 批量刪除按鈕 */}
                                        {selectedIds.size > 0 && (
                                            <button onClick={handleBatchDelete} className="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm flex items-center gap-2 animate-pulse">
                                                <Icon path={ICONS.Trash2} /> 刪除 ({selectedIds.size})
                                            </button>
                                        )}

                                        <input type="file" ref={csvInputRef} onChange={handleImportCSV} accept=".csv" className="hidden" />
                                        <button onClick={() => csvInputRef.current?.click()} disabled={isImporting} className="bg-emerald-700/50 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg text-sm flex items-center gap-2">
                                            {isImporting ? "匯入中..." : <><Icon path={ICONS.Upload} />匯入</>}
                                        </button>
                                        <button onClick={() => handleOpenModal()} className="bg-white text-emerald-700 hover:bg-lime-50 px-3 py-2 rounded-lg font-bold flex items-center gap-2 text-sm"><Icon path={ICONS.Plus} />新增</button>
                                    </>
                                )}
                            </div>
                        </div>
                    </header>
                    <main className="max-w-5xl mx-auto px-4 py-6">
                        {loading && <div className="text-center py-10">載入中...</div>}
                        {!loading && (
                            <>
                                <div className="flex border-b border-slate-200 mb-6 overflow-x-auto">
                                    <button onClick={() => setMainTab('明信片')} className={`whitespace-nowrap pb-3 px-6 text-sm font-bold border-b-2 transition-colors ${mainTab === '明信片' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-slate-500'}`}>明信片</button>
                                    <button onClick={() => setMainTab('純點')} className={`whitespace-nowrap pb-3 px-6 text-sm font-bold border-b-2 transition-colors ${mainTab === '純點' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-slate-500'}`}>純點</button>
                                    <button onClick={() => setMainTab('活動金盆')} className={`whitespace-nowrap pb-3 px-6 text-sm font-bold border-b-2 transition-colors ${mainTab === '活動金盆' ? 'border-amber-500 text-amber-600' : 'border-transparent text-slate-500'}`}>活動金盆</button>
                                </div>
                                <div className="flex flex-col md:flex-row gap-4 mb-8 justify-between">
                                    {mainTab === '明信片' && (
                                        <div className="flex flex-wrap gap-2">{categories.map(cat => (<button key={cat} onClick={() => setActiveCategory(cat)} className={`px-4 py-1.5 rounded-full text-sm font-medium ${activeCategory === cat ? 'bg-emerald-600 text-white' : 'bg-white border border-slate-200 text-slate-600'}`}>{cat}</button>))}</div>
                                    )}
                                    <div className="relative w-full md:w-64"><div className="absolute left-3 top-2.5 text-slate-400"><Icon path={ICONS.Search} /></div><input type="text" placeholder="搜尋地點、名稱或類型..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-4 py-2 rounded-lg border border-slate-200 text-sm" /></div>
                                </div>
                                <div className="space-y-8">
                                    {Object.entries(groupedPostcards).map(([groupKey, items]) => (
                                        <section key={groupKey}>
                                            <div className="flex items-center gap-3 mb-4 pl-3 border-l-4 border-emerald-500">
                                                <h2 className="text-xl font-bold text-slate-700">{groupKey}</h2>
                                                {isAdmin && (
                                                    <button onClick={() => handleGroupDelete(groupKey, items)} className="text-slate-300 hover:text-red-500 transition-colors" title={`刪除所有「${groupKey}」資料`}>
                                                        <Icon path={ICONS.Trash2} />
                                                    </button>
                                                )}
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                {items.map(item => (
                                                    <div key={item.id} className="bg-white rounded-xl shadow-sm border border-slate-100 p-5 relative group">
                                                        {isAdmin && (
                                                            <>
                                                                <div className="absolute top-4 left-4 z-10">
                                                                    <input 
                                                                        type="checkbox" 
                                                                        checked={selectedIds.has(item.id)} 
                                                                        onChange={(e) => {e.stopPropagation(); toggleSelection(item.id);}}
                                                                        className="w-5 h-5 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer shadow-sm"
                                                                    />
                                                                </div>

                                                                <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                                                    <button onClick={(e) => { e.stopPropagation(); handleOpenModal(item); }} className="p-1.5 bg-white border rounded text-slate-400 hover:text-blue-500"><Icon path={ICONS.Edit2} /></button>
                                                                    <button onClick={(e) => { e.stopPropagation(); setDeleteId(item.id); }} className="p-1.5 bg-white border rounded text-slate-400 hover:text-red-500"><Icon path={ICONS.Trash2} /></button>
                                                                </div>
                                                            </>
                                                        )}
                                                        {mainTab === '明信片' && (
                                                            <>
                                                                {item.imageUrl && (<div className="mb-4 -mx-5 -mt-5 h-40 bg-slate-100 overflow-hidden relative rounded-t-xl"><img src={item.imageUrl} alt={item.name} className="w-full h-full object-cover" /></div>)}
                                                                <div className={`mb-3 ${!item.imageUrl ? '' : 'pt-1'}`}>
                                                                    <div className="flex items-center gap-2 mb-1">
                                                                        <span className={`text-[10px] px-2 py-0.5 rounded font-bold uppercase ${
                                                                            item.type === '蘑菇' ? 'bg-purple-100 text-purple-700' : 
                                                                            item.type === '種花' ? 'bg-pink-100 text-pink-700' : 
                                                                            item.type === '隱藏' ? 'bg-indigo-100 text-indigo-700' :
                                                                            'bg-amber-100 text-amber-800'
                                                                        }`}>
                                                                            {item.type}
                                                                        </span>
                                                                        <span className="text-xs text-slate-400">{item.category}</span>
                                                                    </div>
                                                                </div>
                                                            </>
                                                        )}
                                                        {mainTab === '純點' && (
                                                            <div className="mb-3">
                                                                <span className="text-[10px] px-2 py-0.5 rounded font-bold uppercase bg-blue-100 text-blue-700 mr-2">純點</span>
                                                                <span className="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded">{item.type}</span>
                                                            </div>
                                                        )}
                                                        {mainTab === '活動金盆' && (
                                                            <div className="mb-3">
                                                                <span className="text-[10px] px-2 py-0.5 rounded font-bold uppercase bg-amber-100 text-amber-700 mr-2">活動金盆</span>
                                                                <span className="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded">{item.type}</span>
                                                            </div>
                                                        )}
                                                        
                                                        <h3 className="text-lg font-bold text-slate-800 mb-3 line-clamp-1">
                                                            {mainTab === '明信片' ? (item.name || '未命名項目') : (item.location || item.name || '未命名地點')}
                                                        </h3>

                                                        <div className="space-y-3 text-sm text-slate-600">
                                                            {mainTab === '明信片' && (
                                                                <div className="flex items-start gap-2"><div className="mt-0.5 text-emerald-500 shrink-0"><Icon path={ICONS.MapPin} /></div><span>{item.location}</span></div>
                                                            )}
                                                            <div className="bg-slate-50 rounded-lg p-3 space-y-2 border border-slate-100">
                                                                <div className="flex justify-between"><div className="flex gap-2"><span className="text-[10px] font-bold text-slate-400 w-8">Lat</span><code className="text-xs font-mono">{item.lat}</code></div><button onClick={() => handleCopyText(item.lat, `${item.id}-lat`)} className="text-slate-400 hover:text-emerald-500"><Icon path={copyFeedback === `${item.id}-lat` ? ICONS.Check : ICONS.Copy} /></button></div>
                                                                <div className="flex justify-between border-t border-slate-200/50 pt-2"><div className="flex gap-2"><span className="text-[10px] font-bold text-slate-400 w-8">Lng</span><code className="text-xs font-mono">{item.lng}</code></div><button onClick={() => handleCopyText(item.lng, `${item.id}-lng`)} className="text-slate-400 hover:text-emerald-500"><Icon path={copyFeedback === `${item.id}-lng` ? ICONS.Check : ICONS.Copy} /></button></div>
                                                                <div className="border-t border-slate-200/50 pt-2 mt-1">
                                                                    <button 
                                                                        onClick={() => handleCopyText(`${item.lat},${item.lng}`, `${item.id}-all`)} 
                                                                        className="w-full py-1.5 bg-white border border-emerald-200 text-emerald-600 rounded text-xs font-bold flex items-center justify-center gap-1 hover:bg-emerald-50 transition-colors"
                                                                    >
                                                                        <Icon path={copyFeedback === `${item.id}-all` ? ICONS.Check : ICONS.Copy} /> 複製完整座標
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <a href={`https://www.google.com/maps?q=${item.lat},${item.lng}`} target="_blank" rel="noreferrer" className="w-full flex items-center justify-center gap-2 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-medium"><Icon path={ICONS.ExternalLink} />在 Google 地圖中查看</a>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </section>
                                    ))}
                                </div>
                            </>
                        )}
                    </main>
                    {deleteId && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center">
                                <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600"><Icon path={ICONS.AlertTriangle} /></div>
                                <h3 className="text-lg font-bold mb-2">確定要刪除嗎？</h3>
                                <div className="flex gap-3 mt-6"><button onClick={() => setDeleteId(null)} className="flex-1 py-2 rounded-lg border">取消</button><button onClick={confirmDelete} className="flex-1 py-2 rounded-lg bg-red-600 text-white">確認</button></div>
                            </div>
                        </div>
                    )}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl shadow-xl w-full max-w-md flex flex-col max-h-[90vh]">
                                <div className="px-6 py-4 border-b flex justify-between items-center"><h3 className="text-lg font-bold">{editingItem ? '編輯' : '新增'}</h3><button onClick={() => setIsModalOpen(false)}><Icon path={ICONS.X} /></button></div>
                                <form onSubmit={handleSubmit} className="p-6 space-y-4 overflow-y-auto">
                                    {!editingItem && (
                                        <div className="flex bg-slate-100 p-1 rounded-lg mb-2">
                                            <button type="button" onClick={() => setFormData({ ...formData, mainType: '明信片', type: '蘑菇' })} className={`flex-1 py-1.5 text-sm font-bold rounded ${formData.mainType === '明信片' ? 'bg-white shadow text-emerald-600' : 'text-slate-500'}`}>明信片</button>
                                            <button type="button" onClick={() => setFormData({ ...formData, mainType: '純點', type: '' })} className={`flex-1 py-1.5 text-sm font-bold rounded ${formData.mainType === '純點' ? 'bg-white shadow text-emerald-600' : 'text-slate-500'}`}>純點</button>
                                            <button type="button" onClick={() => setFormData({ ...formData, mainType: '活動金盆', type: '' })} className={`flex-1 py-1.5 text-sm font-bold rounded ${formData.mainType === '活動金盆' ? 'bg-white shadow text-emerald-600' : 'text-slate-500'}`}>活動金盆</button>
                                        </div>
                                    )}
                                    {formData.mainType === '明信片' ? (
                                        <>
                                            <div className="space-y-2">
                                                <label className="block text-xs font-bold text-slate-500">明信片照片</label>
                                                <input type="file" ref={fileInputRef} onChange={handleImageChange} accept="image/*" className="hidden" />
                                                {formData.imageUrl ? (
                                                    <div className="relative rounded-lg overflow-hidden border group h-48">
                                                        <img src={formData.imageUrl} alt="Preview" className="w-full h-full object-cover" />
                                                        <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center gap-2 transition-opacity">
                                                            <button type="button" onClick={() => fileInputRef.current?.click()} className="bg-white px-3 py-1 rounded text-xs font-bold">更換</button>
                                                            <button type="button" onClick={handleRemoveImage} className="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold">移除</button>
                                                        </div>
                                                    </div>
                                                ) : (<button type="button" onClick={() => fileInputRef.current?.click()} className="w-full h-32 border-2 border-dashed rounded-lg flex flex-col items-center justify-center text-slate-400 hover:text-emerald-600 hover:bg-emerald-50"><div className="flex flex-col items-center"><Icon path={ICONS.Upload} /><span className="text-xs mt-2">上傳照片</span></div></button>)}
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="text-xs font-bold text-slate-500">大類別</label><input list="cat-opts" className="w-full border rounded p-2 text-sm" value={formData.category} onChange={e => setFormData({ ...formData, category: e.target.value })} /><datalist id="cat-opts">{categories.filter(c => c !== "全部").map(c => <option key={c} value={c} />)}</datalist></div>
                                                <div>
                                                    <label className="text-xs font-bold text-slate-500">類型</label>
                                                    <select className="w-full border rounded p-2 text-sm" value={formData.type} onChange={e => setFormData({ ...formData, type: e.target.value })}>
                                                        <option value="蘑菇">蘑菇</option>
                                                        <option value="種花">種花</option>
                                                        <option value="都有">都有</option>
                                                        <option value="隱藏">隱藏</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div><label className="text-xs font-bold text-slate-500">子類別</label><input list="sub-opts" className="w-full border rounded p-2 text-sm" value={formData.series} onChange={e => setFormData({ ...formData, series: e.target.value })} /><datalist id="sub-opts">{availableSubCategories.map(s => <option key={s} value={s} />)}</datalist></div>
                                            <div><label className="text-xs font-bold text-slate-500">名稱</label><input className="w-full border rounded p-2 text-sm" value={formData.name} onChange={e => setFormData({ ...formData, name: e.target.value })} /></div>
                                        </>
                                    ) : (
                                        <div>
                                            <label className="text-xs font-bold text-slate-500">{formData.mainType === '活動金盆' ? '活動類型' : '純點類型'}</label>
                                            <input list="pure-opts" className="w-full border rounded p-2 text-sm" value={formData.type} onChange={e => setFormData({ ...formData, type: e.target.value })} />
                                            <datalist id="pure-opts">
                                                {formData.mainType === '活動金盆' ? availableEventTypes.map(t => <option key={t} value={t} />) : availablePureTypes.map(t => <option key={t} value={t} />)}
                                            </datalist>
                                        </div>
                                    )}
                                    <div><label className="text-xs font-bold text-slate-500">地點說明</label><input className="w-full border rounded p-2 text-sm" value={formData.location} onChange={e => setFormData({ ...formData, location: e.target.value })} /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs font-bold text-slate-500">緯度 (Lat)</label><input className="w-full border rounded p-2 text-sm font-mono" value={formData.lat} onChange={e => setFormData({ ...formData, lat: e.target.value })} /></div>
                                        <div><label className="text-xs font-bold text-slate-500">經度 (Lng)</label><input className="w-full border rounded p-2 text-sm font-mono" value={formData.lng} onChange={e => setFormData({ ...formData, lng: e.target.value })} /></div>
                                    </div>
                                    <div className="pt-4 flex gap-3">
                                        <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 py-2 border rounded">取消</button>
                                        <button type="submit" disabled={isUploading} className="flex-1 py-2 bg-emerald-600 text-white rounded flex items-center justify-center gap-2">{isUploading ? '上傳中...' : <><Icon path={ICONS.Save} />儲存</>}</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
